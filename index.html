<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EternalBliss - Algorand On-Chain RPG</title>
    <script src="https://cdn.jsdelivr.net/npm/algosdk@2.7.0/dist/browser/algosdk.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="script.js"></script>
</head>
<!-- ADD THIS TO YOUR algorand-rpg-html.html FILE -->

<!-- 1. ADD THE CSS (put this in your <head> section) -->
<style>
/* Map Importer Plugin Styles */
.map-importer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    font-family: 'Courier New', monospace;
}

.map-importer-modal {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    border: 4px solid #3d5a80;
    border-radius: 16px;
    padding: 28px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 16px 32px rgba(0,0,0,0.8);
    color: white;
}

.importer-header {
    text-align: center;
    margin-bottom: 24px;
    color: #fbbf24;
    font-size: 24px;
    font-weight: bold;
}

.import-method-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
}

.import-tab {
    flex: 1;
    padding: 12px;
    background: rgba(0,0,0,0.3);
    border: 2px solid #3d5a80;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    font-size: 12px;
    color: white;
}

.import-tab:hover {
    border-color: #10b981;
    background: rgba(16, 185, 129, 0.1);
}

.import-tab.active {
    border-color: #10b981;
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.import-section {
    display: none;
    margin-bottom: 20px;
}

.import-section.active {
    display: block;
}

.json-textarea {
    width: 100%;
    height: 200px;
    background: rgba(0,0,0,0.5);
    border: 2px solid #3d5a80;
    border-radius: 8px;
    color: white;
    font-family: 'Courier New', monospace;
    font-size: 11px;
    padding: 12px;
    resize: vertical;
    margin-bottom: 12px;
}

.file-input {
    width: 100%;
    padding: 12px;
    background: rgba(0,0,0,0.3);
    border: 2px dashed #3d5a80;
    border-radius: 8px;
    color: white;
    text-align: center;
    cursor: pointer;
    margin-bottom: 12px;
}

.file-input input {
    display: none;
}

.preset-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}

.preset-card {
    background: rgba(0,0,0,0.3);
    border: 2px solid #3d5a80;
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.preset-card:hover {
    border-color: #10b981;
    background: rgba(16, 185, 129, 0.1);
}

.preset-title {
    font-weight: bold;
    margin-bottom: 4px;
    color: #fbbf24;
}

.preset-desc {
    font-size: 11px;
    opacity: 0.8;
}

.import-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
}

.import-btn {
    flex: 1;
    padding: 12px;
    border: 3px solid;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    background: none;
    color: inherit;
}

.import-btn-success {
    background: linear-gradient(135deg, #059669 0%, #10b981 50%, #059669 100%);
    border-color: #065f46;
    color: white;
}

.import-btn-danger {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 50%, #dc2626 100%);
    border-color: #991b1b;
    color: white;
}

.import-status {
    margin-top: 12px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    text-align: center;
    display: none;
}

.status-success {
    background: rgba(16, 185, 129, 0.2);
    border: 1px solid #10b981;
    color: #10b981;
}

.status-error {
    background: rgba(220, 38, 38, 0.2);
    border: 1px solid #dc2626;
    color: #ef4444;
}

.trigger-button {
    position: fixed;
    bottom: 20px;
    right: 80px;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #059669 0%, #10b981 50%, #059669 100%);
    border: 3px solid #065f46;
    border-radius: 50%;
    color: white;
    font-size: 20px;
    cursor: pointer;
    z-index: 1900;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

.trigger-button:hover {
    transform: translateY(-3px) scale(1.1);
}
</style>

<!-- 2. ADD THE HTML (put this right before </body>) -->

<!-- Map Importer Button -->
<div class="trigger-button" id="mapImporterTrigger" title="Import New Map">
    üó∫Ô∏è
</div>

<!-- Map Importer Modal -->
<div class="map-importer-overlay" id="mapImporterOverlay">
    <div class="map-importer-modal">
        <div class="importer-header">
            üó∫Ô∏è EternalBliss Map Importer
        </div>

        <!-- Import Method Tabs -->
        <div class="import-method-tabs">
            <div class="import-tab active" data-tab="json">JSON Data</div>
            <div class="import-tab" data-tab="presets">Quick Presets</div>
        </div>

        <!-- JSON Import Section -->
        <div class="import-section active" id="jsonSection">
            <h4>Paste JSON Map Data</h4>
            <textarea class="json-textarea" id="jsonInput" placeholder="Paste your generated map JSON data here..."></textarea>
            <button class="btn btn-primary" onclick="validateJsonMap()">üîç Validate JSON</button>
        </div>

        <!-- Presets Section -->
        <div class="import-section" id="presetsSection">
            <h4>Quick Load Presets</h4>
            <div class="preset-grid">
                <div class="preset-card" onclick="loadPresetMap('starter_village')">
                    <div class="preset-title">üèòÔ∏è Starter Village</div>
                    <div class="preset-desc">Small beginner-friendly map</div>
                </div>
                <div class="preset-card" onclick="loadPresetMap('large_city')">
                    <div class="preset-title">üèôÔ∏è Large City</div>
                    <div class="preset-desc">Expansive urban map</div>
                </div>
                <div class="preset-card" onclick="loadPresetMap('dungeon')">
                    <div class="preset-title">‚öîÔ∏è Dungeon</div>
                    <div class="preset-desc">Dangerous cave system</div>
                </div>
            </div>
        </div>

        <!-- Import Actions -->
        <div class="import-actions">
            <button class="import-btn import-btn-success" id="importButton" onclick="importMap()" disabled>
                ‚úÖ Import Map
            </button>
            <button class="import-btn import-btn-danger" onclick="closeImporter()">
                ‚ùå Cancel
            </button>
        </div>

        <!-- Status Message -->
        <div class="import-status" id="importStatus"></div>
    </div>
</div>

<!-- 3. ADD THE JAVASCRIPT (put this right before </body>, after the HTML above) -->
<script>
// Map Importer Plugin JavaScript
let currentMapData = null;

function initMapImporter() {
    document.getElementById('mapImporterTrigger').addEventListener('click', openImporter);
    
    document.querySelectorAll('.import-tab').forEach(tab => {
        tab.addEventListener('click', switchTab);
    });

    document.getElementById('mapImporterOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeImporter();
    });
}

function openImporter() {
    document.getElementById('mapImporterOverlay').style.display = 'flex';
    clearImporterState();
}

function closeImporter() {
    document.getElementById('mapImporterOverlay').style.display = 'none';
}

function switchTab(e) {
    const tabName = e.target.dataset.tab;
    
    document.querySelectorAll('.import-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    e.target.classList.add('active');

    document.querySelectorAll('.import-section').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(tabName + 'Section').classList.add('active');
    
    clearImporterState();
}

function clearImporterState() {
    currentMapData = null;
    document.getElementById('importButton').disabled = true;
    document.getElementById('importStatus').style.display = 'none';
}

function validateJsonMap() {
    const jsonText = document.getElementById('jsonInput').value.trim();
    
    if (!jsonText) {
        showStatus('Please enter JSON data', 'error');
        return false;
    }

    try {
        const mapData = JSON.parse(jsonText);
        
        // Comprehensive validation
        const errors = [];
        
        if (!mapData.terrain) errors.push('Missing terrain data');
        if (!mapData.width || mapData.width < 10) errors.push('Invalid or missing width (min: 10)');
        if (!mapData.height || mapData.height < 10) errors.push('Invalid or missing height (min: 10)');
        
        if (mapData.terrain && (!Array.isArray(mapData.terrain) || mapData.terrain.length !== mapData.height)) {
            errors.push('Terrain array height mismatch');
        }
        
        if (mapData.terrain && mapData.terrain.length > 0 && mapData.terrain[0].length !== mapData.width) {
            errors.push('Terrain array width mismatch');
        }
        
        // Check optional arrays
        if (mapData.buildings && !Array.isArray(mapData.buildings)) errors.push('Buildings must be an array');
        if (mapData.npcs && !Array.isArray(mapData.npcs)) errors.push('NPCs must be an array');
        if (mapData.enemies && !Array.isArray(mapData.enemies)) errors.push('Enemies must be an array');
        if (mapData.items && !Array.isArray(mapData.items)) errors.push('Items must be an array');
        if (mapData.areas && !Array.isArray(mapData.areas)) errors.push('Areas must be an array');
        
        if (errors.length > 0) {
            throw new Error(errors.join(', '));
        }
        
        currentMapData = mapData;
        document.getElementById('importButton').disabled = false;
        showStatus('‚úÖ Map validation successful! Ready to import.', 'success');
        return true;
        
    } catch (error) {
        showStatus('‚ùå Invalid JSON: ' + error.message, 'error');
        currentMapData = null;
        document.getElementById('importButton').disabled = true;
        return false;
    }
}

function loadPresetMap(presetName) {
    const presets = {
starter_village: {
    name: "Greenleaf Village",
    width: 35,
    height: 30,
    terrain: generateSimpleGrid(35, 30, 'village'),
    buildings: [
        {x: 15, y: 14, type: 'inn', name: 'The Resting Traveler Inn', class: 'building house inn'},
        {x: 19, y: 14, type: 'shop', name: 'General Goods Store', class: 'building house shop'},
        {x: 12, y: 17, type: 'house', name: 'Farmer\'s House', class: 'building house'},
        {x: 22, y: 17, type: 'house', name: 'Blacksmith\'s Home', class: 'building house'},
        {x: 17, y: 20, type: 'temple', name: 'Village Chapel', class: 'building temple'},
        {x: 10, y: 11, type: 'house', name: 'Miller\'s Cottage', class: 'building house'},
        {x: 24, y: 11, type: 'house', name: 'Elder\'s Residence', class: 'building house'}
    ],
    npcs: [
        {x: 16, y: 15, name: 'Innkeeper Martha', class: 'npc npc-villager', dialogue: 'Welcome, traveler! A warm bed and hot meal await you here.'},
        {x: 20, y: 15, name: 'Merchant Thomas', class: 'npc npc-merchant', dialogue: 'Best prices in the region! Take a look at my wares.'},
        {x: 18, y: 21, name: 'Priest Benedict', class: 'npc npc-priest', dialogue: 'May the light guide your path through these troubled times.'},
        {x: 23, y: 18, name: 'Blacksmith Greta', class: 'npc npc-villager', dialogue: 'Need your weapon sharpened? I\'m the best smith in three villages.'},
        {x: 25, y: 12, name: 'Village Elder', class: 'npc npc-elder', dialogue: 'Dangerous creatures have been spotted near the forest lately. Be careful, young one.'}
    ],
    enemies: [
        {x: 5, y: 8, name: 'Wild Slime', class: 'enemy-spawn enemy-goblin', hp: 20, maxHp: 20, attack: 5, xpReward: 12, goldReward: 8},
        {x: 30, y: 22, name: 'Goblin Scout', class: 'enemy-spawn enemy-goblin', hp: 30, maxHp: 30, attack: 8, xpReward: 20, goldReward: 15},
        {x: 3, y: 25, name: 'Forest Wolf', class: 'enemy-spawn enemy-wolf', hp: 35, maxHp: 35, attack: 10, xpReward: 25, goldReward: 18}
    ],
    items: [
        {x: 27, y: 10, type: 'gold', value: 25},
        {x: 32, y: 20, type: 'health_potion', value: 1},
        {x: 8, y: 9, type: 'gold', value: 35}
    ],
    areas: [
        {id: 1, name: 'Greenleaf Village', x: 10, y: 10, width: 16, height: 13, color: 'rgba(16, 185, 129, 0.3)', description: 'A peaceful farming village'}
    ]
},

    large_city: {
        name: "Port Algorand",
        width: 55,
        height: 45,
        terrain: generateSimpleGrid(55, 45, 'city'),
        buildings: [
            {x: 25, y: 20, type: 'castle', name: 'City Hall & Treasury', class: 'building castle'},
            {x: 18, y: 15, type: 'shop', name: 'ALGO Exchange Market', class: 'building house shop'},
            {x: 32, y: 15, type: 'shop', name: 'Weapon & Armor Shop', class: 'building house shop'},
            {x: 20, y: 25, type: 'inn', name: 'The Golden Anchor Inn', class: 'building house inn'},
            {x: 30, y: 25, type: 'inn', name: 'Sailor\'s Rest Tavern', class: 'building house inn'},
            {x: 25, y: 30, type: 'temple', name: 'Grand Cathedral', class: 'building temple'},
            {x: 15, y: 10, type: 'house', name: 'Merchant Guild', class: 'building house'},
            {x: 35, y: 10, type: 'house', name: 'Mage Tower', class: 'building house'},
            {x: 12, y: 35, type: 'shop', name: 'Port Market', class: 'building house shop'},
            {x: 38, y: 35, type: 'house', name: 'Noble Estate', class: 'building house'}
        ],
        npcs: [
            {x: 26, y: 21, name: 'Mayor Aldrich', class: 'npc npc-elder', dialogue: 'Welcome to Port Algorand, the jewel of the coast!'},
            {x: 19, y: 16, name: 'Exchange Master Felix', class: 'npc npc-merchant', dialogue: 'Looking to exchange currencies? I offer the fairest rates.'},
            {x: 33, y: 16, name: 'Armorer Bjorn', class: 'npc npc-merchant', dialogue: 'Quality steel and enchanted armor for sale.'},
            {x: 21, y: 26, name: 'Innkeeper Rosa', class: 'npc npc-villager', dialogue: 'The finest rooms and ale! Sailors from distant lands stay here.'},
            {x: 26, y: 31, name: 'High Priestess Elena', class: 'npc npc-priest', dialogue: 'The cathedral welcomes all who seek guidance.'},
            {x: 13, y: 36, name: 'Port Master', class: 'npc npc-merchant', dialogue: 'Ships arrive daily with exotic goods.'},
            {x: 16, y: 11, name: 'Guild Master', class: 'npc npc-elder', dialogue: 'Our merchant guild controls all trade routes.'},
            {x: 36, y: 11, name: 'Court Wizard', class: 'npc npc-priest', dialogue: 'Magic flows strong in this city.'}
        ],
        enemies: [
            {x: 48, y: 38, name: 'City Thug', class: 'enemy-spawn enemy-goblin', hp: 45, maxHp: 45, attack: 12, xpReward: 30, goldReward: 25},
            {x: 8, y: 8, name: 'Sewer Rat', class: 'enemy-spawn enemy-wolf', hp: 35, maxHp: 35, attack: 10, xpReward: 22, goldReward: 15},
            {x: 50, y: 15, name: 'Bandit', class: 'enemy-spawn enemy-goblin', hp: 50, maxHp: 50, attack: 14, xpReward: 35, goldReward: 30},
            {x: 45, y: 8, name: 'Corrupt Guard', class: 'enemy-spawn enemy-wolf', hp: 55, maxHp: 55, attack: 16, xpReward: 40, goldReward: 35}
        ],
        items: [
            {x: 40, y: 30, type: 'gold', value: 50},
            {x: 10, y: 20, type: 'mana_potion', value: 1},
            {x: 45, y: 25, type: 'health_potion', value: 1},
            {x: 28, y: 8, type: 'gold', value: 75},
            {x: 15, y: 40, type: 'key', value: 1}
        ],
        areas: [
            {id: 1, name: 'Market District', x: 12, y: 8, width: 18, height: 12, color: 'rgba(251, 191, 36, 0.3)', description: 'Bustling marketplace'},
            {id: 2, name: 'City Center', x: 20, y: 18, width: 15, height: 15, color: 'rgba(59, 130, 246, 0.3)', description: 'Government district'},
            {id: 3, name: 'Port District', x: 8, y: 32, width: 20, height: 12, color: 'rgba(16, 185, 129, 0.3)', description: 'Harbor and docks'}
        ]
    },


dungeon: {
    name: "Caves of the Forgotten",
    width: 40,
    height: 35,
    terrain: generateSimpleGrid(40, 35, 'dungeon'),
    buildings: [
        {x: 20, y: 28, type: 'castle', name: 'Ancient Dragon Lair', class: 'building castle'},
        {x: 10, y: 12, type: 'temple', name: 'Ruined Shrine', class: 'building temple'},
        {x: 30, y: 14, type: 'house', name: 'Abandoned Camp', class: 'building house'}
    ],
    npcs: [
        {x: 11, y: 13, name: 'Lost Adventurer', class: 'npc npc-villager', dialogue: 'I\'ve been trapped here for days... These caves are cursed! Turn back while you still can!'},
        {x: 20, y: 7, name: 'Hermit Sage', class: 'npc npc-priest', dialogue: 'Few venture this deep and return. The dragon guards ancient treasures below.'}
    ],
    enemies: [
        {x: 12, y: 18, name: 'Cave Bat Swarm', class: 'enemy-spawn enemy-goblin', hp: 40, maxHp: 40, attack: 12, xpReward: 28, goldReward: 20},
        {x: 18, y: 19, name: 'Stone Golem', class: 'enemy-spawn enemy-wolf', hp: 70, maxHp: 70, attack: 18, xpReward: 50, goldReward: 35},
        {x: 25, y: 15, name: 'Dark Wraith', class: 'enemy-spawn enemy-dragon', hp: 85, maxHp: 85, attack: 22, xpReward: 65, goldReward: 45},
        {x: 28, y: 19, name: 'Skeletal Guardian', class: 'enemy-spawn enemy-dragon', hp: 60, maxHp: 60, attack: 16, xpReward: 45, goldReward: 30},
        {x: 20, y: 29, name: 'Ancient Red Dragon', class: 'enemy-spawn enemy-dragon', hp: 200, maxHp: 200, attack: 40, xpReward: 150, goldReward: 200}
    ],
    items: [
        {x: 11, y: 14, type: 'health_potion', value: 1},
        {x: 29, y: 15, type: 'mana_potion', value: 1},
        {x: 21, y: 30, type: 'treasure', value: 500},
        {x: 23, y: 28, type: 'gold', value: 150},
        {x: 20, y: 9, type: 'key', value: 1},
        {x: 15, y: 20, type: 'gold', value: 100}
    ],
    areas: [
        {id: 1, name: 'Cave Entrance', x: 17, y: 3, width: 7, height: 8, color: 'rgba(107, 114, 128, 0.3)', description: 'Still safe to retreat'},
        {id: 2, name: 'Deep Caverns', x: 8, y: 16, width: 25, height: 10, color: 'rgba(220, 38, 38, 0.3)', description: 'Dangerous territory'},
        {id: 3, name: 'Dragon\'s Lair', x: 17, y: 26, width: 8, height: 7, color: 'rgba(127, 29, 29, 0.3)', description: 'Certain death awaits'}
    ]
}
    };
    
    currentMapData = presets[presetName];
    document.getElementById('importButton').disabled = false;
    showStatus(`Loaded ${currentMapData.name} preset!`, 'success');
}

function generateSimpleGrid(width, height, type) {
    const grid = [];
    
    // Initialize with base terrain
    for (let y = 0; y < height; y++) {
        grid[y] = [];
        for (let x = 0; x < width; x++) {
            grid[y][x] = 'grass';
        }
    }
    
if (type === 'village') {
    // Add forest patches around edges
    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            if (x < 3 || x >= width - 3 || y < 2 || y >= height - 2) {
                if (Math.random() < 0.4) grid[y][x] = 'forest';
            }
        }
    }
    
    // Add a small pond
    const pondX = Math.floor(width * 0.25);  // FIXED - added space
    const pondY = Math.floor(height * 0.3);  // FIXED - added space
    for (let dy = -1; dy <= 1; dy++) {
        for (let dx = -2; dx <= 2; dx++) {
            if (Math.abs(dx) + Math.abs(dy) <= 2) {
                grid[pondY + dy][pondX + dx] = 'water';
            }
        }
    }
        
        // Main road through center (horizontal)
        const roadY = Math.floor(height / 2);
        for (let x = 0; x < width; x++) {
            grid[roadY][x] = 'road';
            if (Math.random() < 0.3) grid[roadY - 1][x] = 'road';
            if (Math.random() < 0.3) grid[roadY + 1][x] = 'road';
        }
        
        // Vertical road intersection
        const roadX = Math.floor(width / 2);
        for (let y = Math.floor(height * 0.3); y < Math.floor(height * 0.8); y++) {
            grid[y][roadX] = 'road';
        }
        
    } else if (type === 'city') {
        // Grid pattern roads
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                if (x % 8 === 0 || x % 8 === 1 || y % 8 === 0 || y % 8 === 1) {
                    grid[y][x] = 'road';
                }
            }
        }
        
        // Harbor/water at bottom
        for (let y = Math.floor(height * 0.85); y < height; y++) {
            for (let x = 0; x < Math.floor(width * 0.4); x++) {
                grid[y][x] = 'water';
            }
        }
        
        // Small park areas
        const parkX = Math.floor(width * 0.7);
        const parkY = Math.floor(height * 0.65);
        for (let dy = 0; dy < 6; dy++) {
            for (let dx = 0; dx < 8; dx++) {
                if (dx > 0 && dx < 7 && dy > 0 && dy < 5) {
                    grid[parkY + dy][parkX + dx] = 'forest';
                }
            }
        }
        
    } else if (type === 'dungeon') {
        // Start with mostly mountain/walls
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                grid[y][x] = 'mountain';
            }
        }
        
        // Carve out cave chambers using cellular automata-like approach
        const chambers = [
            {cx: Math.floor(width * 0.5), cy: Math.floor(height * 0.15), r: 4},  // Entrance
            {cx: Math.floor(width * 0.25), cy: Math.floor(height * 0.35), r: 5}, // Left chamber
            {cx: Math.floor(width * 0.75), cy: Math.floor(height * 0.4), r: 5},  // Right chamber
            {cx: Math.floor(width * 0.5), cy: Math.floor(height * 0.55), r: 6},  // Central hall
            {cx: Math.floor(width * 0.5), cy: Math.floor(height * 0.8), r: 7}    // Dragon lair
        ];
        
        // Create chambers
        chambers.forEach(chamber => {
            for (let y = chamber.cy - chamber.r; y <= chamber.cy + chamber.r; y++) {
                for (let x = chamber.cx - chamber.r; x <= chamber.cx + chamber.r; x++) {
                    if (y >= 0 && y < height && x >= 0 && x < width) {
                        const dist = Math.sqrt((x - chamber.cx) ** 2 + (y - chamber.cy) ** 2);
                        if (dist <= chamber.r) {
                            grid[y][x] = 'grass';
                        }
                    }
                }
            }
        });
        
        // Connect chambers with corridors
        // Entrance to central
        for (let y = chambers[0].cy; y < chambers[3].cy; y++) {
            grid[y][chambers[0].cx] = 'grass';
            grid[y][chambers[0].cx - 1] = 'grass';
            grid[y][chambers[0].cx + 1] = 'grass';
        }
        
        // Central to left chamber
        for (let x = chambers[1].cx; x < chambers[3].cx; x++) {
            grid[chambers[1].cy][x] = 'grass';
            grid[chambers[1].cy - 1][x] = 'grass';
        }
        
        // Central to right chamber
        for (let x = chambers[3].cx; x < chambers[3].cx + (chambers[2].cx - chambers[3].cx); x++) {
            grid[chambers[2].cy][x] = 'grass';
            grid[chambers[2].cy + 1][x] = 'grass';
        }
        
        // Central to dragon lair
        for (let y = chambers[3].cy; y < chambers[4].cy; y++) {
            grid[y][chambers[3].cx] = 'grass';
            grid[y][chambers[3].cx - 1] = 'grass';
            grid[y][chambers[3].cx + 1] = 'grass';
        }
        
        // Add some scattered rubble/rocks in passages
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                if (grid[y][x] === 'grass' && Math.random() < 0.05) {
                    grid[y][x] = 'sand'; // Use sand as rubble
                }
            }
        }
    }
    
    return grid;
}

function importMap() {
    if (!currentMapData) {
        showStatus('No valid map data to import', 'error');
        return;
    }

    try {
        // Update game world
        gameState.world.width = currentMapData.width;
        gameState.world.height = currentMapData.height;
        gameState.world.areas = currentMapData.areas || []; // ADD THIS
        
        worldMap = currentMapData.terrain;
        buildings = currentMapData.buildings || [];
        npcs = currentMapData.npcs || [];
        enemies = currentMapData.enemies || [];
        items = currentMapData.items || [];
        
        // Reset player position to center
        gameState.player.x = Math.floor(currentMapData.width / 2);
        gameState.player.y = Math.floor(currentMapData.height / 2);
        
        // Update world grid dimensions
        const worldGrid = document.getElementById('worldGrid');
        worldGrid.style.width = `${currentMapData.width * 32}px`;
        worldGrid.style.height = `${currentMapData.height * 32}px`;
        
        // Re-render everything with new dimensions
        renderWorld();
        
        // Force immediate minimap update with new dimensions
        setTimeout(() => {
            initializeMinimap();
            updateMinimapOptimized();
        }, 0);
        
        centerCameraOnPlayer();
        checkLocation();
        updateUI();
        
        showStatus('üéâ Map imported successfully!', 'success');
        showFloatingText('New map loaded!', 
            gameState.player.x * 32 + 16, 
            gameState.player.y * 32 - 40, 
            '#10b981'
        );
        
        setTimeout(closeImporter, 2000);
        
    } catch (error) {
        showStatus('Import failed: ' + error.message, 'error');
        console.error('Map import error:', error);
    }
}

function showStatus(message, type) {
    const statusEl = document.getElementById('importStatus');
    statusEl.textContent = message;
    statusEl.className = `import-status status-${type}`;
    statusEl.style.display = 'block';
}

// Initialize when page loads
window.addEventListener('load', initMapImporter);
if (typeof initMapImporter === 'function') {
    window.addEventListener('load', initMapImporter);
}

console.log('üó∫Ô∏è Map Importer Plugin Ready!');
</script>
<body>
    <div class="game-container">
        <div class="left-panel">
            <div class="wallet-section">
                <h3>üîó Algorand Wallet</h3>
                <div class="wallet-methods">
                    <div class="wallet-method active" onclick="setWalletMethod('mnemonic')" id="mnemonicMethod">
                        Mnemonic Phrase
                    </div>
                </div>
                <div id="walletInputSection">
                    <textarea class="wallet-input" id="walletInput" placeholder="Enter your 25-word Algorand mnemonic phrase..." rows="3"></textarea>
                    <button class="btn btn-primary" onclick="connectWallet()" style="width: 100%; margin-top: 8px;">
                        üîó Connect to Algorand
                    </button>
                </div>
                <div id="walletConnected" style="display: none;">
                    <div style="font-size: 11px; margin-bottom: 6px;"><strong>Connected:</strong></div>
                    <div style="font-size: 10px; font-family: monospace; word-break: break-all;" id="connectedAddress"></div>
                    <div style="font-size: 10px; margin-top: 4px; color: #10b981;">Algorand Mainnet</div>
                    <div style="font-size: 10px; margin-top: 4px;">Balance: <span id="algoBalance">0</span> ALGO</div>
                    <button class="btn btn-danger" onclick="disconnectWallet()" style="width: 100%; margin-top: 8px; font-size: 10px;">
                        Disconnect
                    </button>
                </div>
            </div>

            <div class="character-info">
                <h3>‚öîÔ∏è Hero Stats</h3>
                <div style="margin: 12px 0;">
                    <div style="margin-bottom: 8px;">
                        <strong>Level:</strong> <span id="playerLevel">1</span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Location:</strong> <span id="currentLocation">Starter Village</span>
                    </div>
                    
                    <div style="margin-bottom: 4px; font-size: 12px; color: #ef4444;">‚ù§Ô∏è Health</div>
                    <div class="stat-bar">
                        <div class="stat-fill hp-fill" id="playerHpBar" style="width: 100%"></div>
                    </div>
                    <div style="font-size: 11px; margin-bottom: 8px;">
                        <span id="playerHp">100</span>/<span id="playerMaxHp">100</span>
                    </div>
                    
                    <div style="margin-bottom: 4px; font-size: 12px; color: #3b82f6;">üíß Mana</div>
                    <div class="stat-bar">
                        <div class="stat-fill mp-fill" id="playerMpBar" style="width: 100%"></div>
                    </div>
                    <div style="font-size: 11px; margin-bottom: 8px;">
                        <span id="playerMp">50</span>/<span id="playerMaxMp">50</span>
                    </div>
                    
                    <div style="margin-bottom: 4px; font-size: 12px; color: #fbbf24;">‚≠ê Experience</div>
                    <div class="stat-bar">
                        <div class="stat-fill xp-fill" id="playerXpBar" style="width: 0%"></div>
                    </div>
                    <div style="font-size: 11px;">
                        <span id="playerXp">0</span>/<span id="playerXpNext">100</span>
                    </div>
                </div>
            </div>

            <div class="inventory">
                <h3>üéí Inventory</h3>
                <div class="inventory-item">
                    <span><span class="item-icon">üí∞</span>Gold</span>
                    <span id="goldAmount">100</span>
                </div>
                <div class="inventory-item">
                    <span><span class="item-icon">üß™</span>Health Potions</span>
                    <span id="healthPotions">3</span>
                </div>
                <div class="inventory-item">
                    <span><span class="item-icon">üîÆ</span>Mana Potions</span>
                    <span id="manaPotions">2</span>
                </div>
                <div class="inventory-item">
                    <span><span class="item-icon">üóùÔ∏è</span>Keys</span>
                    <span id="keyCount">0</span>
                </div>
            </div>

            <div class="multiplayer-section">
                <h3>üë• Multiplayer</h3>
                
                <div>
                    <p><strong>Online Players: <span id="onlineCount">1</span></strong></p>
                    <div class="online-players" id="onlinePlayersList">
                        <div class="player-item">You are here</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>üí¨ World Chat</h4>
                    <div style="height: 120px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 8px; margin: 10px 0; font-size: 0.8em;" id="chatMessages"></div>
                    
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="chatInput" placeholder="Type message..." style="flex: 1; padding: 8px;" maxlength="100">
                        <button class="btn btn-primary" id="sendChatBtn">Send</button>
                    </div>
                </div>
            </div>

            <div style="margin-top: 16px; display: grid; gap: 8px;">
                <button class="btn btn-success" onclick="syncWithAlgorand()" style="width: 100%;" id="syncButton">
                    üîÑ Sync from Algorand
                </button>
                <button class="btn btn-primary" onclick="saveToAlgorand()" style="width: 100%;" id="saveButton" disabled>
                    üíæ Save to Algorand
                </button>
                <button class="btn btn-warning" onclick="createPlayerNFT()" style="width: 100%; display: none;" id="nftButton">
                    üé® Mint Player NFT
                </button>
            </div>
        </div>

        <div class="main-game">
            <div class="connection-status disconnected" id="connectionStatus">
                ‚ö° Disconnected
            </div>
            
            <div class="location-info">
                <div style="font-size: 16px; font-weight: bold;" id="locationName">üèòÔ∏è Starter Village</div>
                <div class="desktop-controls-hint" style="font-size: 11px; opacity: 0.8; margin-top: 4px;">WASD/Arrows: Move | Space: Interact</div>
            </div>

            <div class="minimap">
                <div style="padding: 8px; font-size: 12px; font-weight: bold; border-bottom: 2px solid #3d5a80;">
                    üó∫Ô∏è World Map
                </div>
                <div class="minimap-content" id="minimapContent"></div>
            </div>

            <div class="world-view" id="worldView">
                <div class="world-grid" id="worldGrid">
                </div>
            </div>

            <div class="ui-panel">
                <div class="stat-block">
                    <div style="font-size: 13px; margin-bottom: 8px; color: #fbbf24;">‚öîÔ∏è COMBAT STATS</div>
                    <div style="font-size: 12px; margin-bottom: 3px;">
                        <span style="color: #ef4444;">ATK:</span> <span id="attackStat">15</span>
                    </div>
                    <div style="font-size: 12px; margin-bottom: 3px;">
                        <span style="color: #3b82f6;">DEF:</span> <span id="defenseStat">10</span>
                    </div>
                    <div style="font-size: 12px;">
                        <span style="color: #8b5cf6;">MAG:</span> <span id="magicStat">20</span>
                    </div>
                </div>

                <div class="stat-block">
                    <div style="font-size: 13px; margin-bottom: 8px; color: #10b981;">üéØ PROGRESS</div>
                    <div style="font-size: 11px; margin-bottom: 3px;" id="quickInfo1">Enemies Defeated: 0</div>
                    <div style="font-size: 11px; margin-bottom: 3px;" id="quickInfo2">Treasures Found: 0</div>
                    <div style="font-size: 11px;" id="quickInfo3">Position: (4, 3)</div>
                </div>

                <div class="controls">
                    <div></div>
                    <div class="control-btn" onclick="movePlayer(0, -1)" title="Move Up">‚Üë</div>
                    <div></div>
                    <div class="control-btn" onclick="movePlayer(-1, 0)" title="Move Left">‚Üê</div>
                    <div class="control-btn interact" onclick="interact()" title="Interact">‚ö°</div>
                    <div class="control-btn" onclick="movePlayer(1, 0)" title="Move Right">‚Üí</div>
                    <div></div>
                    <div class="control-btn" onclick="movePlayer(0, 1)" title="Move Down">‚Üì</div>
                    <div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Interaction Modal -->
    <div class="modal" id="interactionModal">
        <div class="modal-content">
            <h3 id="modalTitle">Building Name</h3>
            <div id="modalContent">Content goes here</div>
            <div style="margin-top: 24px;">
                <button class="btn btn-primary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Battle Modal -->
    <div class="modal battle-modal" id="battleModal">
        <div class="modal-content">
            <h3 style="font-size: 24px; margin-bottom: 16px;">‚öîÔ∏è BATTLE COMMENCED!</h3>
            <div class="battle-arena">
                <div class="battle-character battle-player">üßô‚Äç‚ôÇÔ∏è</div>
                <div style="font-size: 40px; animation: battle-lightning 1s ease-in-out infinite;">‚ö°</div>
                <div class="battle-character battle-enemy" id="battleEnemy">üêâ</div>
            </div>
            
            <div style="margin-bottom: 16px;">
                <div style="font-size: 16px; margin-bottom: 8px;">
                    üéØ <span id="enemyName">Dragon</span>
                </div>
                <div class="stat-bar" style="margin: 0 auto; width: 60%;">
                    <div class="stat-fill hp-fill" id="enemyHpBar" style="width: 100%"></div>
                </div>
                <div style="font-size: 12px; margin-top: 4px;">
                    HP: <span id="enemyHp">80</span>/<span id="enemyMaxHp">80</span>
                </div>
            </div>

            <div class="battle-actions">
                <button class="btn btn-primary" onclick="battleAction('attack')">‚öîÔ∏è Attack</button>
                <button class="btn btn-primary" onclick="battleAction('magic')">‚ú® Magic</button>
                <button class="btn btn-success" onclick="battleAction('heal')">üíö Heal</button>
                <button class="btn btn-primary" onclick="battleAction('flee')">üèÉ Flee</button>
            </div>

            <div class="battle-log" id="battleLog"></div>
        </div>
    </div>

    <!-- Mobile Controls -->
    <div id="mobile-controls">
        <button data-dir="up" class="ctl-btn up">‚ñ≤</button>
        <button data-dir="left" class="ctl-btn left">‚óÄ</button>
        <button data-dir="down" class="ctl-btn down">‚ñº</button>
        <button data-dir="right" class="ctl-btn right">‚ñ∂</button>
    </div>

    <!-- Transaction Status Modal -->
    <div class="modal" id="txModal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <h3>üîÑ Transaction Status</h3>
            <div id="txStatus" style="margin: 20px 0; text-align: center;">
                <div class="loading-spinner"></div>
                <p style="margin-top: 15px;">Processing transaction...</p>
            </div>
            <div id="txResult" style="display: none;">
                <p id="txMessage"></p>
                <div style="margin-top: 15px;">
                    <a id="txLink" href="#" target="_blank" style="color: #10b981;">View on AlgoExplorer</a>
                </div>
            </div>
            <button class="btn btn-primary" onclick="closeTxModal()" style="margin-top: 20px; width: 100%;">Close</button>
        </div>
    </div>
</body>
</html>
